#!/usr/bin/python3

import os
import subprocess
import sys

shell = os.environ["SHELL"]


def main():
    argv = sys.argv
    if len(argv) == 1:
        call_fzf()
    else:
        if argv[1] == "picker":
            run_plugins_picker(" ".join(argv[2:]))
        elif argv[1] == "run":
            run_plugins(" ".join(argv[2:]))


def call_fzf():
    path = os.path.realpath(__file__)
    cmd = [
        "foot",
        "-a",
        "fzfmenu",
        "-e",
        "fzf",
        f"--bind 'start,change:reload:python {path} picker {{q}}'",
        f"--bind 'enter:execute(setsid python {path} run {{}} > /dev/null 2>&1)+abort'",
    ]

    subprocess.call(
        " ".join(cmd),
        shell=True,
    )


def run_plugins(output: str):
    if output.startswith("kl "):
        killer_runner(output)
    elif output.startswith("wd "):
        window_jump_runner(output)
    elif output.startswith("hs "):
        history_runner(output)
    else:
        open_application_runner(output)


def open_application_runner(output: str):
    desktop = output.split(" ")[-1]
    if os.path.exists(desktop):
        subprocess.call(f"dex {desktop}", shell=True)


def window_jump_runner(output: str):
    args = output.split(" ")
    workspace_id = args[-2]
    window_index = args[-1]
    if not workspace_id.isnumeric():
        workspace_id = f'"{workspace_id}"'
    command = f"ura.win.activate({workspace_id},{window_index})"
    subprocess.call(f"uracil -c '{command}'", shell=True)


def run_plugins_picker(input: str):
    if input.startswith("wd "):
        window_jump_picker(input)
    elif input.startswith("kl "):
        killer_picker(input)
    elif input.startswith("hs "):
        history_picker(input)
    else:
        open_application_picker(input)


def window_jump_picker(input):
    input = input.removeprefix("wd ")
    command = " ".join(
        [
            "local workspaces = ura.ws.list()",
            "for _, workspace in ipairs(workspaces) do",
            "for _, toplevel in ipairs(workspace.windows) do",
            "if workspace.name then",
            "print(toplevel.app_id, toplevel.title, workspace.name, toplevel.index)",
            "else",
            "print(toplevel.app_id, toplevel.title, workspace.index, toplevel.index)",
            "end",
            "end",
            "end",
        ]
    )
    output = subprocess.check_output(
        f"uracil -c '{command}'", shell=True, text=True
    ).strip()
    for line in output.splitlines():
        line = line.strip()
        print("wd " + line)


def open_application_picker_by_path(path: str):
    output = subprocess.check_output(
        f"fd -a .desktop {path}", shell=True, text=True
    ).strip()
    for path in output.splitlines():
        if no_display_is_true(path):
            continue
        name = get_name_by_path(path)
        if name is not None:
            print(name + " " + path)


def open_application_picker(_):
    open_application_picker_by_path("/usr/share/applications/")
    open_application_picker_by_path(os.path.expanduser("~/.local/share/applications/"))
    open_application_picker_by_path(os.path.expanduser("~/Desktop/"))


def no_display_is_true(path: str):
    with open(path, "r") as f:
        for line in f.readlines():
            if line.startswith("NoDisplay=true"):
                return True
    return False


def get_name_by_path(path: str):
    with open(path, "r") as f:
        for line in f.readlines():
            if line.startswith("Name="):
                return line.removeprefix("Name=").strip()


def killer_picker(input: str):
    input = input.removeprefix("kl ")
    if len(input) == 0:
        return
    output = subprocess.check_output(f"pgrep -fa {input}", shell=True).strip().decode()
    path = os.path.realpath(__file__)
    for line in output.splitlines():
        if path in line:
            continue
        print("kl " + line)


def killer_runner(output: str):
    pid = output.removeprefix("kl ").split(" ")[0]
    subprocess.call([shell, "-c", f"kill -9 {pid}"])


def history_picker(input):
    input = input.removeprefix("hs ")
    atuin_init_cmd = ""
    if "zsh" in shell:
        atuin_init_cmd = 'eval "$(atuin init zsh)"'
    elif "bash" in shell:
        atuin_init_cmd = 'eval "$(atuin init bash)"'
    elif "fish" in shell:
        atuin_init_cmd = "atuin init fish | source"

    output = (
        subprocess.check_output(
            [
                "zsh",
                "-c",
                f'{atuin_init_cmd} && atuin search "{input}" --cmd-only',
            ]
        )
        .strip()
        .decode()
    )

    for line in set(output.splitlines()):
        print("hs " + line)


def history_runner(output: str):
    cmd = output.removeprefix("hs ")
    subprocess.call(f"setsid {cmd} > /dev/null 2>&1", shell=True)


if __name__ == "__main__":
    main()
